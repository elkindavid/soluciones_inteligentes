{% extends 'base.html' %}
{% block title %}Opt de Compras de CarbÃ³n{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-4">

  <h2 class="mb-6 text-center text-2xl font-bold">ğŸ§® Modelo de OptimizaciÃ³n de Compras de CarbÃ³n</h2>

  <form method="POST" enctype="multipart/form-data">

    <!-- Cargar archivo -->
    <div class="bg-white shadow rounded-lg mb-4">
      <div class="bg-blue-500 text-white px-4 py-2 rounded-t-lg">ğŸ“¥ Cargar datos</div>
      <div class="p-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Archivo de datos (.xlsx):</label>
        <input type="file" name="archivo"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"
          {% if not session.get('archivo_path') %}required{% endif %}>
        {% if session.get('archivo_path') %}
          <small class="text-green-600">ğŸ“ Archivo cargado: {{ session['archivo_path'].split('/')[-1] }}</small>
        {% endif %}
      </div>
    </div>

    <!-- ParÃ¡metros -->
    <div class="bg-white shadow rounded-lg mb-4">
      <div class="bg-gray-500 text-white px-4 py-2 rounded-t-lg">âš™ï¸ ParÃ¡metros del modelo</div>
      <div class="p-4">
        <label class="inline-flex items-center space-x-2 mb-3">
          <input type="checkbox" name="solo_mineros" id="solo_mineros"
            class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring focus:ring-blue-200"
            {% if solo_mineros %}checked{% endif %}>
          <span class="text-sm text-gray-700">âœ… Solo incluir mineros</span>
        </label>

        <div class="mb-4">
          <label for="limite" class="block text-sm font-medium text-gray-700 mb-1">
            ğŸ”’ LÃ­mite de participaciÃ³n: <span id="valor_limite">{{ limite_comercializadores }}</span>%
          </label>
          <input type="range" name="limite" id="limite" min="0" max="100"
            value="{{ limite_comercializadores }}"
            oninput="document.getElementById('valor_limite').innerText = this.value"
            class="w-full accent-blue-500">
        </div>

        <div class="mb-2">
          <span class="block text-sm font-medium text-gray-700 mb-1">ğŸ¯ Criterio de optimizaciÃ³n:</span>
          <label class="inline-flex items-center space-x-2 mr-4">
            <input type="radio" name="modelo" id="modelo_precio" value="precio"
              class="rounded-full border-gray-300 text-blue-600 shadow-sm focus:ring focus:ring-blue-200"
              {% if modelo_usado != 'costo_ccb' %}checked{% endif %}>
            <span class="text-sm">Minimizar Precio</span>
          </label>
          <label class="inline-flex items-center space-x-2">
            <input type="radio" name="modelo" id="modelo_costo_ccb" value="costo_ccb"
              class="rounded-full border-gray-300 text-blue-600 shadow-sm focus:ring focus:ring-blue-200"
              {% if modelo_usado == 'costo_ccb' %}checked{% endif %}>
            <span class="text-sm">Minimizar Costo CCB</span>
          </label>
        </div>

      </div>
    </div>

    <!-- BotÃ³n -->
    <div class="text-center mb-5">
      <button class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg text-lg">ğŸš€ Ejecutar modelo</button>
    </div>
  </form>

  {% if estado %}
  <!-- Resultados -->
  <div class="bg-white shadow rounded-lg mb-4">
    <div class="bg-green-500 text-white px-4 py-2 rounded-t-lg">âœ… Resultados del modelo</div>
    <div class="p-4">
      <h5 class="mb-2">ğŸ“Œ Estado del modelo: {{ estado }}</h5>
      <h5 class="mb-2">ğŸ§  Criterio de optimizaciÃ³n usado: {{ 'Costo CCB' if modelo_usado == 'costo_ccb' else 'Precio' }}</h5>
      <a href="{{ url_for('optimizacion.descargar_excel') }}"
         class="inline-block bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg my-3">
         ğŸ“¥ Descargar resultados en Excel
      </a>
    </div>
  </div>

  <div class="mb-4">
    <h5 class="text-lg font-semibold mb-2">ğŸ“Š Tabla de resultados</h5>
    {{ tabla_resultados|safe }}
  </div>

  <div class="mb-5">
    <h5 class="text-lg font-semibold mb-2">ğŸ“ˆ Calidad y rendimiento alcanzado</h5>
    <div class="overflow-x-auto">
      {{ tabla_resumen|safe }}
    </div>
  </div>

  <!-- GrÃ¡ficos -->
  <div class="text-center mt-5">
    <h5 class="text-lg font-semibold mb-2">DistribuciÃ³n por tipo de carbÃ³n</h5>
    <img src="data:image/png;base64,{{ grafico_torta }}" class="mx-auto mt-2" style="width:50%;height:auto;">
  </div>

  <div class="mt-5 text-center">
    <h5 class="text-lg font-semibold mb-2">Compra Ã³ptima por mina y pila</h5>
    <img src="data:image/png;base64,{{ grafico_barras }}" class="mx-auto mt-2" style="width:100%; max-width:1200px;">
  </div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {
    $('#tabla_resultados').DataTable();
  });
</script>
{% endblock %}