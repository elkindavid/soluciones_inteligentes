{% extends "base.html" %}
{% block title %}CONTROL LOG√çSTICO{% endblock %}

<!-- {% block styles %}
<link rel="stylesheet" href="{{ url_for('informes.static', filename='css/estilo.css') }}">
{% endblock %} -->

{% block content %}

<div class="w-full mx-auto p-4">

  <h1 class="mb-6 text-center text-2xl font-bold flex items-center justify-center gap-2">
    <img src="{{ url_for('informes.static', filename='images/pi.png') }}" 
         alt="PI" class="h-8 inline-block">
    CONTROL LOG√çSTICO
  </h1>
  
  <p class="mb-6 text-sm text-gray-600 text-justify">
    Esta vista est√° dise√±ada para conocer en tiempo real los ingresos de material comercial en los centros log√≠sticos propios registrados a trav√©s del software de <strong>Pesaje Inteligente (PI)</strong>. 
    Cubre escenarios de <em>Compras</em> (ingresos directos desde el proveedor) y <em>Traslados</em> (ingresos por traslados entre centros propios).  
    Se puede conocer el detalle carro a carro con las toneladas de material entregado en un rango de fechas y filtrar acorde a lo requerido.
  </p>

  <!-- Filtros -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="bg-blue-500 text-white px-4 py-2 rounded-t-lg">üîé Filtros</div>
    <div class="p-4 grid grid-cols-1 md:grid-cols-8 gap-4">

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de ingreso</label>
        <select id="filtro-tipo" class="select2 w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-blue-200" multiple>
          <option value="Compras" selected>Compras</option>
          <option value="traslados">Traslados</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
        <input type="date" id="filtro-desde" class="w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-blue-200">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
        <input type="date" id="filtro-hasta" class="w-full rounded-md border-gray-300 shadow-sm focus:ring focus:ring-blue-200">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Pedido</label>
        <select id="filtro-pedido" class="select2 w-full" multiple>
          {% for p in pedidos %}
            <option value="{{ p }}">{{ p }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Origen</label>
        <select id="filtro-origen" class="select2 w-full" multiple>
          {% for o in origenes %}
            <option value="{{ o }}">{{ o }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Destino</label>
        <select id="filtro-destino" class="select2 w-full" multiple>
          {% for d in destinos %}
            <option value="{{ d }}">{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Transportadora</label>
        <select id="filtro-transportadora" class="select2 w-full" multiple>
          {% for t in transportadoras %}
            <option value="{{ t }}">{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Placa</label>
        <select id="filtro-placa" class="select2 w-full" multiple>
          {% for p in placas %}
            <option value="{{ p }}">{{ p }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor Material</label>
        <select id="filtro-proveedor" class="select2 w-full" multiple>
          {% for p in proveedores %}
            <option value="{{ p }}">{{ p }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Tarjetas -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-green-100 rounded-lg shadow p-4 text-center">
      <h5 class="text-lg font-semibold mb-2">Ingreso Neto</h5>
      <p class="text-2xl font-bold text-green-700" id="ingreso-neto">0 t</p>
    </div>
    <div class="bg-blue-100 rounded-lg shadow p-4 text-center">
      <h5 class="text-lg font-semibold mb-2">Cant. Viajes</h5>
      <p class="text-2xl font-bold text-blue-700" id="num-viajes">0</p>
    </div>
    <div class="bg-yellow-100 rounded-lg shadow p-4 text-center">
      <h5 class="text-lg font-semibold mb-2">Cant. Proveedores</h5>
      <p class="text-2xl font-bold text-yellow-700" id="num-proveedores">0</p>
    </div>
    <div class="bg-red-100 rounded-lg shadow p-4 text-center">
      <h5 class="text-lg font-semibold mb-2">Registros con alerta</h5>
      <p class="text-2xl font-bold text-red-700" id="num-alertas">0</p>
    </div>    
  </div>

  <!-- Tabla -->
  <div class="bg-white shadow rounded-lg">
    <div class="bg-gray-500 text-white px-4 py-2 rounded-t-lg">üìë Resultados</div>
    <div class="p-4 overflow-x-auto">
      <table id="tabla" class="display nowrap w-full">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
let tabla;

// üîÑ Funci√≥n para actualizar din√°micamente las listas de filtros
function actualizarFiltros(origenFiltro = null) {
    let params = {
        tipo: ($("#filtro-tipo").val() || []).join(","), 
        desde: $("#filtro-desde").val(),
        hasta: $("#filtro-hasta").val(),
        pedido: ($("#filtro-pedido").val() || []).join(","), 
        origen: ($("#filtro-origen").val() || []).join(","),
        destino: ($("#filtro-destino").val() || []).join(","), 
        transportadora: ($("#filtro-transportadora").val() || []).join(","), 
        placa: ($("#filtro-placa").val() || []).join(","),
        proveedor_mat: ($("#filtro-proveedor").val() || []).join(","), 
        
        
    };

    $.getJSON("/reporte/filtros", params, function(data) {
        // Actualizar solo los dem√°s filtros, no el que dispar√≥ el evento
        if (origenFiltro !== "filtro-pedido") actualizarSelect("#filtro-pedido", data.pedidos, params.pedido);
        if (origenFiltro !== "filtro-origen") actualizarSelect("#filtro-origen", data.origenes, params.origen);
        if (origenFiltro !== "filtro-destino") actualizarSelect("#filtro-destino", data.destinos, params.destino);
        if (origenFiltro !== "filtro-transportadora") actualizarSelect("#filtro-transportadora", data.transportadoras, params.transportadora);
        if (origenFiltro !== "filtro-placa") actualizarSelect("#filtro-placa", data.placas, params.placa);
        if (origenFiltro !== "filtro-proveedor") actualizarSelect("#filtro-proveedor", data.proveedores, params.proveedor_mat);
        
        // luego de refrescar filtros ‚Üí recargar tabla
        cargarDatos();
    });
}



// üõ† Funci√≥n auxiliar para refrescar select2 manteniendo selecciones v√°lidas
function actualizarSelect(selector, opciones, seleccionados) {
    let $select = $(selector);
    let actuales = seleccionados ? seleccionados.split(",") : [];

    $select.empty();
    $.each(opciones, function(_, opcion) {
        let opt = new Option(opcion, opcion, false, actuales.includes(opcion));
        $select.append(opt);
    });
    $select.trigger("change.select2");
}

// üìä Funci√≥n para cargar tabla
function cargarDatos() {
    let btn = $("#btn-filtrar");
    btn.prop("disabled", true).text("Cargando... ‚è≥");

    let params = {
        tipo: ($("#filtro-tipo").val() || []).join(","), 
        desde: $("#filtro-desde").val(),
        hasta: $("#filtro-hasta").val(),
        pedido: ($("#filtro-pedido").val() || []).join(","), 
        origen: ($("#filtro-origen").val() || []).join(","), 
        destino: ($("#filtro-destino").val() || []).join(","), 
        transportadora: ($("#filtro-transportadora").val() || []).join(","), 
        placa: ($("#filtro-placa").val() || []).join(","),
        proveedor_mat: ($("#filtro-proveedor").val() || []).join(",")
    };

    $.getJSON("/reporte/data", params, function(res) {
        if (!res || res.length === 0) {
            $("#ingreso-neto").text("0 t");
            $("#num-viajes").text("0");
            if (tabla) { tabla.clear().draw(); }
            return;
        }

        // Totales
        let totalToneladas = res.reduce((acc, x) => acc + (parseFloat(x.toneladas || x.Toneladas || 0)), 0);
        let totalViajes = res.reduce((acc, x) => acc + (parseFloat(x.num_viajes || x.NumViajes || 1)), 0);
        $("#ingreso-neto").text(totalToneladas.toFixed(2) + " t");
        $("#num-viajes").text(totalViajes);

        // üü° KPI Proveedores distintos
        let proveedoresUnicos = [...new Set(res.map(x => x.Proveedor))];
        $("#num-proveedores").text(proveedoresUnicos.length);

        // üî¥ KPI Registros con alerta
        let registrosConAlerta = res.filter(row => {
            return Object.values(row).some(val => {
                if (val === null || val === undefined) return true;
                if (typeof val === "string") {
                    let v = val.trim().toLowerCase();
                    return v === "" || v === "0" || v === "na" || v === "n/a" || v === "no aplica";
                }
                if (typeof val === "number") {
                    return val === 0;
                }
                return false;
            });
        }).length;

$("#num-alertas").text(registrosConAlerta);

        // Tabla
        let columnas = [
            { data: "NumTiquete", title: "No Tiquete"},
            { data: "NumeroPedido", title: "Pedido"},
            { data: "Posicion", title: "Pos.",},
            { data: "CodMaterial", title: "C√≥d. Mat."},
            { data: "Material", title: "Material" },
            { data: "Placa", title: "Placa"},
            { data: "Toneladas", title: "Cant. Ton.", render: $.fn.dataTable.render.number('.', ',', 2, '')},
            { data: "Fecha", title: "Fecha"},
            { data: "CodPlanta", title: "Cod. CeLog"},
            { data: "CentroLogistico", title: "Centro log√≠stico"},
            { data: "CodOrigen", title: "C√≥d. Origen"},
            { data: "Origen", title: "Origen" },
            { data: "DptoOrigen", title: "Dpto. Origen" },
            { data: "CiudadOrigen", title: "Ciudad Origen" },
            { data: "CodProveedor", title: "Cod. Prov."},
            { data: "Proveedor", title: "Proveedor" },
            { data: "CodEmpresaTpte", title: "Cod. Empresa Tpte" },
            { data: "NombreEmpresaTpte", title: "Empresa Tpte" },
            { data: "TipoVehiculo", title: "Tipo de Veh√≠culo" },
            { data: "Trailer", title: "Trailer" },
            { data: "NumRecibo", title: "No Recibo"}
        ];

        if (!tabla) {
          tabla = $("#tabla").DataTable({
              data: res,
              columns: columnas,
              order: [[13, 'desc']],
              paging: true,
              pageLength: 10,
              lengthMenu: [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"] ],
              searching: true,
              ordering: true,
              responsive: true,
              scrollX: true,
              destroy: true,
              autoWidth: false,
              dom: 'Blfrtip', // 'l' = select de registros por p√°gina
              buttons: [
                  // { extend: 'excelHtml5', text: 'üìä Exportar a Excel', className: 'bg-green-500 text-white px-4 py-2 rounded-lg' },
                  // { extend: 'pdfHtml5', text: 'üìÑ Exportar a PDF', className: 'bg-red-500 text-white px-4 py-2 rounded-lg', orientation: 'landscape', pageSize: 'Legal' },
                  // { extend: 'print', text: 'üñ®Ô∏è Imprimir', className: 'bg-gray-500 text-white px-4 py-2 rounded-lg' }
              ],
              language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
              initComplete: function () {
                $("#tabla_wrapper").css("font-size", "11px");

                // üëá Recalcular anchos de columnas
                this.api().columns.adjust();
              }
          });

        } else {
            tabla.clear();
            tabla.rows.add(res);
            tabla.draw();
        }
    }).fail(function(xhr) {
        console.error("‚ùå Error AJAX:", xhr.status, xhr.responseText);
        alert("Error al cargar los datos. Revisa la consola.");
    }).always(function() {
        btn.prop("disabled", false).text("Aplicar filtros");
    });
}

$(document).ready(function() {
    // Inicializar select2
    $(".select2").select2({ placeholder: "Selecciona...", allowClear: true, width: "100%" });

    // Fechas iniciales
    const hoy = new Date();
    const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
    $("#filtro-desde").val(primerDia.toISOString().split("T")[0]);
    $("#filtro-hasta").val(ultimoDia.toISOString().split("T")[0]);

    // Evento: cada vez que cambie algo en filtros ‚Üí actualizar cascada
    $("#filtro-tipo, #filtro-pedido, #filtro-origen, #filtro-destino, #filtro-transportadora, #filtro-placa, #filtro-proveedor, #filtro-desde, #filtro-hasta")
      .on("change", function() {
          let id = $(this).attr("id");
          actualizarFiltros(id);
      });

    // Carga inicial
    actualizarFiltros();
});
</script>
{% endblock %}


