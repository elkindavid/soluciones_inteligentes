<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}App de Destajos{% endblock %}</title>
  <link rel="manifest" href="{{ url_for('static', filename='manifest-v2.json') }}">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- DataTables CSS (solo base) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- DataTables Buttons CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

  {% block styles %}{% endblock %}
</head>
<body class="bg-slate-50 text-slate-800">
  <nav class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2 text-sky-600 font-semibold">
        <a href="/">Home</a>
        <span>•</span>
        <a href="javascript:void(0)" onclick="history.back()">Volver</a>
      </div>
      
      <div class="flex items-center space-x-4">
        {% if current_user.is_authenticated %}
          <div 
            x-data="{ open: false, online: navigator.onLine }"
            x-init="
              window.addEventListener('online', () => online = true);
              window.addEventListener('offline', () => { online = false; open = false });
            "
            class="relative"
          >
            <button 
              @click="open = !open" 
              class="flex items-center space-x-1 text-sm font-medium text-slate-700 hover:text-sky-600"
            >
              <span>{{ current_user.name }}</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <div 
              x-show="open && online" 
              @click.away="open = false" 
              class="absolute right-0 mt-2 w-56 bg-white border rounded shadow-md z-20"
            >
              {% if current_user.is_authenticated and current_user.superusuario %}
                <a href="{{ url_for('admin.panel') }}" 
                  class="block px-4 py-2 text-sm hover:bg-slate-100">
                  ⚙️ Permisos de usuario
                </a>
              {% endif %}
              <a href="{{ url_for('auth.change_password') }}" class="block px-4 py-2 text-sm hover:bg-slate-100">🔑 Cambiar contraseña</a>
              
              {% if current_user.is_admin %}
                <a href="{{ url_for('auth.register') }}" class="block px-4 py-2 text-sm hover:bg-slate-100">➕ Nuevo usuario</a>
                <a href="{{ url_for('auth.listado') }}" class="block px-4 py-2 text-sm hover:bg-slate-100">👥 Listado</a>
              {% endif %}
              
              <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-red-600 hover:bg-slate-100" onclick="clearLocalAuth()">⎋ Salir</a>
            </div>
          </div>
        {% else %}
          <a class="text-sm" href="{{ url_for('auth.login') }}">Entrar</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <main class="w-full mx-auto p-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div x-data="{ show: true }" x-init="setTimeout(() => show = false, 3000)">
          {% for category, msg in messages %}
            <div
              x-show="show"
              x-transition.opacity.duration.500ms
              class="fixed top-5 right-5 
                    {% if category == 'success' %}bg-green-500{% elif category == 'warning' %}bg-yellow-500{% elif category == 'danger' %}bg-red-500{% else %}bg-gray-500{% endif %} 
                    text-white px-4 py-2 rounded shadow-lg z-50">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script src="{{ url_for('static', filename='js/indexedDB.js') }}"></script>
  <script src="{{ url_for('static', filename='js/tailwind-tables.js') }}"></script>
  <script src="{{ url_for('static', filename='js/alpine.min.js') }}" defer></script>
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <!-- DataTables Buttons + export dependencies -->
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () =>{
      await initDB(); // Inicializa IndexedDB
      console.log("Base de datos lista para usarse");
    })
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js")
        .then(() => console.log("✅ Service Worker registrado"))
        .catch(err => console.error("❌ Error registrando SW:", err));
    }
  </script>

{% block scripts %}{% endblock %}
</body>
</html>
